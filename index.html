<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>不動産投資シミュレーションツール</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    label { display: inline-block; width: 200px; margin-bottom: 5px; }
    input, select { margin-bottom: 5px; }
    .section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
    table { border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #aaa; padding: 5px; text-align: right; }
    th { background-color: #f0f0f0; }
    td:first-child, th:first-child { text-align: left; }
  </style>
</head>
<body>
  <h1>不動産投資シミュレーションツール</h1>
  <form id="simForm">
    <div class="section">
      <h2>【物件情報】</h2>
      <label>築年数:</label>
      <input type="text" id="buildingAge" class="number-format" value="10" inputmode="numeric"><br>
      <label>物件購入価格:</label>
      <input type="text" id="purchasePrice" class="number-format" value="50,000,000" inputmode="numeric"><br>
      <label>満室時収入（月額）:</label>
      <input type="text" id="monthlyIncome" class="number-format" value="300,000" inputmode="numeric"><br>
      <label>購入時諸費用:</label>
      <input type="text" id="purchaseExpenses" class="number-format" value="5,000,000" inputmode="numeric"><br>
      <label>自己資金（投下資本）:</label>
      <input type="text" id="equity" class="number-format" value="15,000,000" inputmode="numeric"><br>
    </div>

    <div class="section">
      <h2>【第1ローン】</h2>
      <label>ローン総額:</label>
      <input type="text" id="loan1Amount" class="number-format" value="25,000,000" inputmode="numeric"><br>
      <label>ローン金利（初期, %）:</label>
      <input type="text" id="loan1Interest" class="number-format" value="2.0" inputmode="numeric" step="0.1"><br>
      <label>返済期間（年）:</label>
      <input type="text" id="loan1Term" class="number-format" value="25" inputmode="numeric"><br>
      <label>返済方式:</label>
      <select id="loan1Type">
        <option value="均等">元利均等返済</option>
        <option value="均等元金">元金均等返済</option>
      </select>
    </div>

    <div class="section">
      <h2>【第2ローン（オプション）】</h2>
      <label>ローン総額:</label>
      <input type="text" id="loan2Amount" class="number-format" value="0" inputmode="numeric"><br>
      <label>ローン金利（初期, %）:</label>
      <input type="text" id="loan2Interest" class="number-format" value="0" inputmode="numeric" step="0.1"><br>
      <label>返済期間（年）:</label>
      <input type="text" id="loan2Term" class="number-format" value="0" inputmode="numeric"><br>
      <label>返済方式:</label>
      <select id="loan2Type">
        <option value="均等">元利均等返済</option>
        <option value="均等元金">元金均等返済</option>
      </select>
    </div>

    <div class="section">
      <h2>【運営費用・その他】</h2>
      <label>管理費（年間）:</label>
      <input type="text" id="managementFee" class="number-format" value="300,000" inputmode="numeric"><br>
      <label>固都税（年間）:</label>
      <input type="text" id="fixedTax" class="number-format" value="200,000" inputmode="numeric"><br>
      <label>建物管理費（年間）:</label>
      <input type="text" id="buildingMgmtFee" class="number-format" value="150,000" inputmode="numeric"><br>
      <label>雑収入（年間）:</label>
      <input type="text" id="miscIncome" class="number-format" value="0" inputmode="numeric"><br>
    </div>

    <div class="section">
      <h2>【税金・減価償却】</h2>
      <label>年間減価償却費:</label>
      <input type="text" id="annualDepreciation" class="number-format" value="1,000,000" inputmode="numeric"><br>
      <label>税率（所得税・住民税, %）:</label>
      <input type="text" id="taxRate" class="number-format" value="21" inputmode="numeric" step="0.1"><br>
      <label>譲渡所得税率 (%):</label>
      <input type="text" id="capitalGainsTaxRate" class="number-format" value="15" inputmode="numeric" step="0.1"><br>
      <label>土地取得負債割合 (%):</label>
      <input type="text" id="landLoanRatio" class="number-format" value="30" inputmode="numeric" step="1"><br>
    </div>

    <div class="section">
      <h2>【その他シミュレーション条件】</h2>
      <label>保有期間（年）:</label>
      <input type="text" id="holdingPeriod" class="number-format" value="10" inputmode="numeric"><br>
      <label>割引率（期待収益率, %）:</label>
      <input type="text" id="discountRate" class="number-format" value="5" inputmode="numeric" step="0.1"><br>
    </div>

    <div class="section">
      <h2>【売却時】</h2>
      <label>売却価格:</label>
      <input type="text" id="salePrice" class="number-format" value="60,000,000" inputmode="numeric"><br>
      <label>売却諸費用:</label>
      <input type="text" id="saleExpenses" class="number-format" value="3,000,000" inputmode="numeric"><br>
    </div>

    <button type="button" onclick="calculateSimulation()">シミュレーション開始</button>
  </form>

  <div id="results"></div>

  <script>
    // ヘルパー関数：小数点以下切り捨て＋コンマ付き文字列に変換
    function formatNumber(num) {
      return Math.floor(num).toLocaleString();
    }
    // ヘルパー関数：パーセント表示（整数に切り捨て）
    function formatPercent(num) {
      return Math.floor(num * 100) + " %";
    }

    // 数値入力欄のフォーマット処理（フォーカス時はカンマ除去、ブラー時にカンマ付与）
    document.addEventListener("DOMContentLoaded", function() {
      const numberInputs = document.querySelectorAll('.number-format');
      numberInputs.forEach(input => {
        input.addEventListener('focus', function(e) {
          input.value = input.value.replace(/,/g, '');
        });
        input.addEventListener('blur', function(e) {
          let value = input.value.replace(/,/g, '');
          if(value === "" || isNaN(value)) return;
          input.value = formatNumber(Number(value));
        });
      });
    });

    // ローンスケジュール計算（各年ごとの返済額、利息、元金、残高）
    function calculateLoanSchedule(loanAmount, annualRate, term, loanType, simYears) {
      let schedule = [];
      let balance = loanAmount;
      annualRate = annualRate / 100;
      if(loanAmount <= 0) {
        for(let y = 1; y <= simYears; y++){
          schedule.push({year: y, payment: 0, interest: 0, principal: 0, balance: 0});
        }
        return schedule;
      }
      if(loanType === "均等") {
        let r = annualRate;
        let n = term;
        let payment = loanAmount * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
        for(let y = 1; y <= simYears; y++){
          if(y <= term) {
            let interest = balance * r;
            let principal = payment - interest;
            balance = balance - principal;
            if(balance < 0) balance = 0;
            schedule.push({year: y, payment: payment, interest: interest, principal: principal, balance: balance});
          } else {
            schedule.push({year: y, payment: 0, interest: 0, principal: 0, balance: 0});
          }
        }
      } else if(loanType === "均等元金") {
        let n = term;
        let principalPayment = loanAmount / n;
        for(let y = 1; y <= simYears; y++){
          if(y <= term) {
            let interest = balance * annualRate;
            let payment = principalPayment + interest;
            balance = balance - principalPayment;
            if(balance < 0) balance = 0;
            schedule.push({year: y, payment: payment, interest: interest, principal: principalPayment, balance: balance});
          } else {
            schedule.push({year: y, payment: 0, interest: 0, principal: 0, balance: 0});
          }
        }
      }
      return schedule;
    }

    // IRR計算（ニュートン法）
    function calculateIRR(cashFlows, guess = 0.1) {
      const tol = 1e-6;
      const maxIter = 1000;
      let rate = guess;
      for (let iter = 0; iter < maxIter; iter++) {
        let npv = 0, d_npv = 0;
        for (let t = 0; t < cashFlows.length; t++) {
          npv += cashFlows[t] / Math.pow(1 + rate, t);
          if (t > 0) {
            d_npv -= t * cashFlows[t] / Math.pow(1 + rate, t + 1);
          }
        }
        let newRate = rate - npv / d_npv;
        if (Math.abs(newRate - rate) < tol) return newRate;
        rate = newRate;
      }
      return rate;
    }

    function calculateSimulation() {
      // 数値は各入力欄のカンマを除去して取得
      function getNumber(id) {
        return Number(document.getElementById(id).value.replace(/,/g, ''));
      }
      const purchasePrice = getNumber("purchasePrice");
      const monthlyIncome = getNumber("monthlyIncome");
      const purchaseExpenses = getNumber("purchaseExpenses");
      const equity = getNumber("equity");
      const holdingPeriod = getNumber("holdingPeriod");

      // 第1ローン
      const loan1Amount = getNumber("loan1Amount");
      const loan1Interest = getNumber("loan1Interest");
      const loan1Term = getNumber("loan1Term");
      const loan1Type = document.getElementById("loan1Type").value;
      // 第2ローン（オプション）
      const loan2Amount = getNumber("loan2Amount");
      const loan2Interest = getNumber("loan2Interest");
      const loan2Term = getNumber("loan2Term");
      const loan2Type = document.getElementById("loan2Type").value;

      // 運営費用・雑収入
      const managementFee = getNumber("managementFee");
      const fixedTax = getNumber("fixedTax");
      const buildingMgmtFee = getNumber("buildingMgmtFee");
      const miscIncome = getNumber("miscIncome");

      // 税・減価償却
      const annualDepreciation = getNumber("annualDepreciation");
      const taxRate = getNumber("taxRate") / 100;

      // 売却時
      const salePrice = getNumber("salePrice");
      const saleExpenses = getNumber("saleExpenses");

      // 計算項目
      const GPI = monthlyIncome * 12;
      const EGI = GPI * 0.9 + miscIncome;
      const OPEx = managementFee + fixedTax + buildingMgmtFee;
      const NOI = EGI - OPEx;
      const FCR = NOI / (purchasePrice + purchaseExpenses);

      // ローンスケジュール作成
      const loan1Schedule = calculateLoanSchedule(loan1Amount, loan1Interest, loan1Term, loan1Type, holdingPeriod);
      const loan2Schedule = calculateLoanSchedule(loan2Amount, loan2Interest, loan2Term, loan2Type, holdingPeriod);

      let totalLoan = loan1Amount + loan2Amount;
      let firstYearPayment = (holdingPeriod >= 1) ? (loan1Schedule[0].payment + loan2Schedule[0].payment) : 0;
      const loanConstantK = totalLoan > 0 ? firstYearPayment / totalLoan : 0;

      let resultsArray = [];
      let btcCashFlows = [-equity];
      let atcCashFlows = [-equity];
      let cumulativeBTCFo = 0;
      let cumulativeATCFo = 0;

      for (let year = 1; year <= holdingPeriod; year++) {
        const l1 = loan1Schedule[year - 1];
        const l2 = loan2Schedule[year - 1];
        const ADS = l1.payment + l2.payment;
        const totalLoanInterest = l1.interest + l2.interest;

        const BTCFo = NOI - ADS;
        let taxableIncome = NOI - totalLoanInterest - annualDepreciation;
        if (taxableIncome < 0) taxableIncome = 0;
        const tax = taxableIncome * taxRate;
        const ATCFo = NOI - ADS - tax;

        cumulativeBTCFo += BTCFo;
        cumulativeATCFo += ATCFo;

        resultsArray.push({
          year: year,
          GPI: GPI,
          EGI: EGI,
          OPEx: OPEx,
          NOI: NOI,
          ADS: ADS,
          BTCFo: BTCFo,
          tax: tax,
          ATCFo: ATCFo,
          cumulativeATCFo: cumulativeATCFo,
          loanBalance: l1.balance + l2.balance
        });
        btcCashFlows.push(BTCFo);
        atcCashFlows.push(ATCFo);
      }

      // 売却時の処理（最終年に売却キャッシュフローを加算）
      const remainingLoanBalance = loan1Schedule[holdingPeriod - 1].balance + loan2Schedule[holdingPeriod - 1].balance;
      const saleNet = salePrice - saleExpenses - remainingLoanBalance;
      resultsArray[holdingPeriod - 1].BTCFo += saleNet;
      resultsArray[holdingPeriod - 1].ATCFo += saleNet;
      cumulativeBTCFo += saleNet;
      cumulativeATCFo += saleNet;
      btcCashFlows[btcCashFlows.length - 1] += saleNet;
      atcCashFlows[atcCashFlows.length - 1] += saleNet;
      
      const irrBefore = calculateIRR(btcCashFlows);
      const irrAfter = calculateIRR(atcCashFlows);
      const yieldGap = FCR - loanConstantK;

      const metricLabels = [
        "GPI（総潜在収入）",
        "EGI（実効総収入）",
        "OPEx（運営費用）",
        "NOI（純営業収益）",
        "ADS（元利返済額）",
        "BTCFo（税引前CF）",
        "税金",
        "ATCFo（税引後CF）",
        "累計ATCFo（税引後CF累計）",
        "残ローン残高（合計）"
      ];
      
      let tableData = {
        "GPI（総潜在収入）": [],
        "EGI（実効総収入）": [],
        "OPEx（運営費用）": [],
        "NOI（純営業収益）": [],
        "ADS（元利返済額）": [],
        "BTCFo（税引前CF）": [],
        "税金": [],
        "ATCFo（税引後CF）": [],
        "累計ATCFo（税引後CF累計）": [],
        "残ローン残高（合計）": []
      };
      
      resultsArray.forEach(r => {
        tableData["GPI（総潜在収入）"].push(formatNumber(r.GPI));
        tableData["EGI（実効総収入）"].push(formatNumber(r.EGI));
        tableData["OPEx（運営費用）"].push(formatNumber(r.OPEx));
        tableData["NOI（純営業収益）"].push(formatNumber(r.NOI));
        tableData["ADS（元利返済額）"].push(formatNumber(r.ADS));
        tableData["BTCFo（税引前CF）"].push(formatNumber(r.BTCFo));
        tableData["税金"].push(formatNumber(r.tax));
        tableData["ATCFo（税引後CF）"].push(formatNumber(r.ATCFo));
        tableData["累計ATCFo（税引後CF累計）"].push(formatNumber(r.cumulativeATCFo));
        tableData["残ローン残高（合計）"].push(formatNumber(r.loanBalance));
      });
      
      let equityRow = Array(holdingPeriod).fill(formatNumber(equity));
      let equityMultiplierRow = resultsArray.map(r => Math.floor(r.cumulativeATCFo / equity).toString());
      let finalOperatingProfitRow = resultsArray.map(r => formatNumber(r.cumulativeATCFo - equity));
      
      let tableHTML = "<h2>年次シミュレーション結果</h2>";
      tableHTML += "<table>";
      tableHTML += "<tr><th>項目</th>";
      for (let year = 1; year <= holdingPeriod; year++) {
        tableHTML += `<th>${year}年目</th>`;
      }
      tableHTML += "</tr>";
      
      metricLabels.forEach(label => {
        tableHTML += `<tr><td>${label}</td>`;
        tableData[label].forEach(val => {
          tableHTML += `<td>${val}</td>`;
        });
        tableHTML += "</tr>";
      });
      
      tableHTML += `<tr><td>運営売却キャッシュフロー累計（B）</td>`;
      tableData["累計ATCFo（税引後CF累計）"].forEach(val => {
        tableHTML += `<td>${val}</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += `<tr><td>自己資金（A）</td>`;
      equityRow.forEach(val => {
        tableHTML += `<td>${val}</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += `<tr><td>自己資金倍率（B/A）</td>`;
      equityMultiplierRow.forEach(val => {
        tableHTML += `<td>${val} 倍</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += `<tr><td>最終想定運用益（B-A）</td>`;
      finalOperatingProfitRow.forEach(val => {
        tableHTML += `<td>${val} 円</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += "</table>";
      
      let summaryHTML = "<h3>主要指標</h3>";
      summaryHTML += `<p>FCR（キャッシュフロー率）：${formatPercent(FCR)}</p>`;
      summaryHTML += `<p>ローン定数K：${formatPercent(loanConstantK)}</p>`;
      summaryHTML += `<p>イールドギャップ：${formatPercent(yieldGap)}</p>`;
      summaryHTML += `<p>IRR（税引前）：${Math.floor(irrBefore * 100)} %</p>`;
      summaryHTML += `<p>IRR（税引後）：${Math.floor(irrAfter * 100)} %</p>`;
      
      let glossaryHTML = "<h3>各指標の意味（用語解説）</h3><ul>";
      glossaryHTML += "<li>GPI（総潜在収入）：満室時の年間収入（＝月収×12）</li>";
      glossaryHTML += "<li>EGI（実効総収入）：GPIから空室損失・未回収損失を差し引き、雑収入を加えた実際の収入（概ねGPIの90% + 雑収入）</li>";
      glossaryHTML += "<li>OPEx（運営費用）：管理費、固都税、建物管理費などの合計</li>";
      glossaryHTML += "<li>NOI（純営業収益）：EGIからOPExを差し引いた収益</li>";
      glossaryHTML += "<li>ADS（元利返済額）：ローン返済額（元本＋利息）</li>";
      glossaryHTML += "<li>BTCFo（税引前CF）：NOIからADSを差し引いたキャッシュフロー</li>";
      glossaryHTML += "<li>ATCFo（税引後CF）：NOIからADSと税金（21%）を差し引いたキャッシュフロー</li>";
      glossaryHTML += "<li>累計ATCFo：各年のATCFoを累積した値</li>";
      glossaryHTML += "<li>残ローン残高：各年末時点のローン残高合計</li>";
      glossaryHTML += "<li>運営売却キャッシュフロー累計（B）：累計ATCFoのこと</li>";
      glossaryHTML += "<li>自己資金（A）：初期の自己資金</li>";
      glossaryHTML += "<li>自己資金倍率（B/A）：累計ATCFoを自己資金で割った値</li>";
      glossaryHTML += "<li>最終想定運用益（B-A）：累計ATCFoから自己資金を差し引いた値</li>";
      glossaryHTML += "</ul>";
      
      document.getElementById("results").innerHTML = tableHTML + summaryHTML + glossaryHTML;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>不動産投資シミュレーションツール</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    label { display: inline-block; width: 200px; margin-bottom: 5px; }
    input, select { margin-bottom: 5px; }
    .section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
    table { border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #aaa; padding: 5px; text-align: right; }
    th { background-color: #f0f0f0; }
    td:first-child, th:first-child { text-align: left; }
  </style>
</head>
<body>
  <h1>不動産投資シミュレーションツール</h1>
  <form id="simForm">
    <div class="section">
      <h2>【物件情報】</h2>
      <label>築年数:</label>
      <input type="number" id="buildingAge" value="10"><br>
      <label>物件購入価格:</label>
      <input type="number" id="purchasePrice" value="50000000"><br>
      <label>満室時収入（月額）:</label>
      <input type="number" id="monthlyIncome" value="300000"><br>
      <label>購入時諸費用:</label>
      <input type="number" id="purchaseExpenses" value="5000000"><br>
      <label>自己資金（投下資本）:</label>
      <input type="number" id="equity" value="15000000"><br>
    </div>

    <div class="section">
      <h2>【第1ローン】</h2>
      <label>ローン総額:</label>
      <input type="number" id="loan1Amount" value="25000000"><br>
      <label>ローン金利（初期, %）:</label>
      <input type="number" id="loan1Interest" value="2.0" step="0.1"><br>
      <label>返済期間（年）:</label>
      <input type="number" id="loan1Term" value="25"><br>
      <label>返済方式:</label>
      <select id="loan1Type">
        <option value="均等">元利均等返済</option>
        <option value="均等元金">元金均等返済</option>
      </select>
    </div>

    <div class="section">
      <h2>【第2ローン（オプション）】</h2>
      <label>ローン総額:</label>
      <input type="number" id="loan2Amount" value="0"><br>
      <label>ローン金利（初期, %）:</label>
      <input type="number" id="loan2Interest" value="0" step="0.1"><br>
      <label>返済期間（年）:</label>
      <input type="number" id="loan2Term" value="0"><br>
      <label>返済方式:</label>
      <select id="loan2Type">
        <option value="均等">元利均等返済</option>
        <option value="均等元金">元金均等返済</option>
      </select>
    </div>

    <div class="section">
      <h2>【運営費用・その他】</h2>
      <label>管理費（年間）:</label>
      <input type="number" id="managementFee" value="300000"><br>
      <label>固都税（年間）:</label>
      <input type="number" id="fixedTax" value="200000"><br>
      <label>建物管理費（年間）:</label>
      <input type="number" id="buildingMgmtFee" value="150000"><br>
      <label>雑収入（年間）:</label>
      <input type="number" id="miscIncome" value="0"><br>
    </div>

    <div class="section">
      <h2>【税金・減価償却】</h2>
      <label>年間減価償却費:</label>
      <input type="number" id="annualDepreciation" value="1000000"><br>
      <label>税率（所得税・住民税, %）:</label>
      <input type="number" id="taxRate" value="21" step="0.1"><br>
      <label>譲渡所得税率 (%):</label>
      <input type="number" id="capitalGainsTaxRate" value="15" step="0.1"><br>
      <label>土地取得負債割合 (%):</label>
      <input type="number" id="landLoanRatio" value="30" step="1"><br>
    </div>

    <div class="section">
      <h2>【その他シミュレーション条件】</h2>
      <label>保有期間（年）:</label>
      <input type="number" id="holdingPeriod" value="10"><br>
      <label>割引率（期待収益率, %）:</label>
      <input type="number" id="discountRate" value="5" step="0.1"><br>
    </div>

    <div class="section">
      <h2>【売却時】</h2>
      <label>売却価格:</label>
      <input type="number" id="salePrice" value="60000000"><br>
      <label>売却諸費用:</label>
      <input type="number" id="saleExpenses" value="3000000"><br>
    </div>

    <button type="button" onclick="calculateSimulation()">シミュレーション開始</button>
  </form>

  <div id="results"></div>

  <script>
    // ローンスケジュール計算（各年ごとの返済額、利息、元金、残高）
    function calculateLoanSchedule(loanAmount, annualRate, term, loanType, simYears) {
      let schedule = [];
      let balance = loanAmount;
      annualRate = annualRate / 100;
      if(loanAmount <= 0) {
        // 借入金がなければ、各年ゼロで返す
        for(let y = 1; y <= simYears; y++){
          schedule.push({year: y, payment: 0, interest: 0, principal: 0, balance: 0});
        }
        return schedule;
      }
      if(loanType === "均等") {
        let r = annualRate;
        let n = term;
        let payment = loanAmount * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
        for(let y = 1; y <= simYears; y++){
          if(y <= term) {
            let interest = balance * r;
            let principal = payment - interest;
            balance = balance - principal;
            if(balance < 0) balance = 0;
            schedule.push({year: y, payment: payment, interest: interest, principal: principal, balance: balance});
          } else {
            schedule.push({year: y, payment: 0, interest: 0, principal: 0, balance: 0});
          }
        }
      } else if(loanType === "均等元金") {
        let n = term;
        let principalPayment = loanAmount / n;
        for(let y = 1; y <= simYears; y++){
          if(y <= term) {
            let interest = balance * annualRate;
            let payment = principalPayment + interest;
            balance = balance - principalPayment;
            if(balance < 0) balance = 0;
            schedule.push({year: y, payment: payment, interest: interest, principal: principalPayment, balance: balance});
          } else {
            schedule.push({year: y, payment: 0, interest: 0, principal: 0, balance: 0});
          }
        }
      }
      return schedule;
    }

    // IRR計算（ニュートン法）
    function calculateIRR(cashFlows, guess = 0.1) {
      const tol = 1e-6;
      const maxIter = 1000;
      let rate = guess;
      for (let iter = 0; iter < maxIter; iter++) {
        let npv = 0, d_npv = 0;
        for (let t = 0; t < cashFlows.length; t++) {
          npv += cashFlows[t] / Math.pow(1 + rate, t);
          if (t > 0) {
            d_npv -= t * cashFlows[t] / Math.pow(1 + rate, t + 1);
          }
        }
        let newRate = rate - npv / d_npv;
        if (Math.abs(newRate - rate) < tol) return newRate;
        rate = newRate;
      }
      return rate;
    }

    function calculateSimulation() {
      // 入力値の取得
      const purchasePrice = Number(document.getElementById("purchasePrice").value);
      const monthlyIncome = Number(document.getElementById("monthlyIncome").value);
      const purchaseExpenses = Number(document.getElementById("purchaseExpenses").value);
      const equity = Number(document.getElementById("equity").value);
      const holdingPeriod = Number(document.getElementById("holdingPeriod").value);

      // 第1ローン
      const loan1Amount = Number(document.getElementById("loan1Amount").value);
      const loan1Interest = Number(document.getElementById("loan1Interest").value);
      const loan1Term = Number(document.getElementById("loan1Term").value);
      const loan1Type = document.getElementById("loan1Type").value;
      // 第2ローン（オプション）
      const loan2Amount = Number(document.getElementById("loan2Amount").value);
      const loan2Interest = Number(document.getElementById("loan2Interest").value);
      const loan2Term = Number(document.getElementById("loan2Term").value);
      const loan2Type = document.getElementById("loan2Type").value;

      // 運営費用・雑収入
      const managementFee = Number(document.getElementById("managementFee").value);
      const fixedTax = Number(document.getElementById("fixedTax").value);
      const buildingMgmtFee = Number(document.getElementById("buildingMgmtFee").value);
      const miscIncome = Number(document.getElementById("miscIncome").value);

      // 税・減価償却
      const annualDepreciation = Number(document.getElementById("annualDepreciation").value);
      const taxRate = Number(document.getElementById("taxRate").value) / 100;

      // 売却時
      const salePrice = Number(document.getElementById("salePrice").value);
      const saleExpenses = Number(document.getElementById("saleExpenses").value);

      // 計算項目
      const GPI = monthlyIncome * 12;  // 総潜在収入：満室時の年間収入
      const EGI = GPI * 0.9 + miscIncome;  // 実効総収入
      const OPEx = managementFee + fixedTax + buildingMgmtFee;  // 運営費用
      const NOI = EGI - OPEx;  // 純営業収益
      const FCR = NOI / (purchasePrice + purchaseExpenses);  // キャッシュフロー率

      // ローンスケジュール作成
      const loan1Schedule = calculateLoanSchedule(loan1Amount, loan1Interest, loan1Term, loan1Type, holdingPeriod);
      const loan2Schedule = calculateLoanSchedule(loan2Amount, loan2Interest, loan2Term, loan2Type, holdingPeriod);

      // ローン定数K：初年度合計返済額／（第1＋第2ローンの借入総額）
      let totalLoan = loan1Amount + loan2Amount;
      let firstYearPayment = (holdingPeriod >= 1) ? (loan1Schedule[0].payment + loan2Schedule[0].payment) : 0;
      const loanConstantK = totalLoan > 0 ? firstYearPayment / totalLoan : 0;

      // 各年ごとのシミュレーション結果
      let resultsArray = [];
      // キャッシュフロー配列（IRR計算用）
      let btcCashFlows = [-equity];
      let atcCashFlows = [-equity];

      let cumulativeBTCFo = 0;
      let cumulativeATCFo = 0;

      for (let year = 1; year <= holdingPeriod; year++) {
        // 各年のローン返済
        const l1 = loan1Schedule[year - 1];
        const l2 = loan2Schedule[year - 1];
        const ADS = l1.payment + l2.payment;  // 元利返済額
        const totalLoanInterest = l1.interest + l2.interest;

        const BTCFo = NOI - ADS;  // 税引前キャッシュフロー
        let taxableIncome = NOI - totalLoanInterest - annualDepreciation;
        if (taxableIncome < 0) taxableIncome = 0;
        const tax = taxableIncome * taxRate;
        const ATCFo = NOI - ADS - tax;  // 税引後キャッシュフロー

        cumulativeBTCFo += BTCFo;
        cumulativeATCFo += ATCFo;

        resultsArray.push({
          year: year,
          GPI: GPI,
          EGI: EGI,
          OPEx: OPEx,
          NOI: NOI,
          ADS: ADS,
          BTCFo: BTCFo,
          tax: tax,
          ATCFo: ATCFo,
          cumulativeATCFo: cumulativeATCFo,
          loanBalance: l1.balance + l2.balance
        });
        btcCashFlows.push(BTCFo);
        atcCashFlows.push(ATCFo);
      }

      // 売却時の処理：最終年に売却キャッシュフローを加算
      const remainingLoanBalance = loan1Schedule[holdingPeriod - 1].balance + loan2Schedule[holdingPeriod - 1].balance;
      const saleNet = salePrice - saleExpenses - remainingLoanBalance;
      resultsArray[holdingPeriod - 1].BTCFo += saleNet;
      resultsArray[holdingPeriod - 1].ATCFo += saleNet;
      cumulativeBTCFo += saleNet;
      cumulativeATCFo += saleNet;
      btcCashFlows[btcCashFlows.length - 1] += saleNet;
      atcCashFlows[atcCashFlows.length - 1] += saleNet;
      
      // IRR計算
      const irrBefore = calculateIRR(btcCashFlows);
      const irrAfter = calculateIRR(atcCashFlows);

      // イールドギャップ：FCR - ローン定数K
      const yieldGap = FCR - loanConstantK;

      // 表示用の転置テーブル作成
      // 各指標ごとに行を用意（結果は小数点以下2桁で表示）
      const metricLabels = [
        "GPI（総潜在収入）",
        "EGI（実効総収入）",
        "OPEx（運営費用）",
        "NOI（純営業収益）",
        "ADS（元利返済額）",
        "BTCFo（税引前CF）",
        "税金",
        "ATCFo（税引後CF）",
        "累計ATCFo（税引後CF累計）",
        "残ローン残高（合計）"
      ];
      
      // 各項目の各年の値を配列で作成
      let tableData = {
        "GPI（総潜在収入）": [],
        "EGI（実効総収入）": [],
        "OPEx（運営費用）": [],
        "NOI（純営業収益）": [],
        "ADS（元利返済額）": [],
        "BTCFo（税引前CF）": [],
        "税金": [],
        "ATCFo（税引後CF）": [],
        "累計ATCFo（税引後CF累計）": [],
        "残ローン残高（合計）": []
      };
      
      resultsArray.forEach(r => {
        tableData["GPI（総潜在収入）"].push(r.GPI.toFixed(0));
        tableData["EGI（実効総収入）"].push(r.EGI.toFixed(0));
        tableData["OPEx（運営費用）"].push(r.OPEx.toFixed(0));
        tableData["NOI（純営業収益）"].push(r.NOI.toFixed(0));
        tableData["ADS（元利返済額）"].push(r.ADS.toFixed(0));
        tableData["BTCFo（税引前CF）"].push(r.BTCFo.toFixed(0));
        tableData["税金"].push(r.tax.toFixed(0));
        tableData["ATCFo（税引後CF）"].push(r.ATCFo.toFixed(0));
        tableData["累計ATCFo（税引後CF累計）"].push(r.cumulativeATCFo.toFixed(0));
        tableData["残ローン残高（合計）"].push(r.loanBalance.toFixed(0));
      });
      
      // 追加で、運営売却キャッシュフロー累計（B）は累計ATCFo、自己資金（A）は equity、
      // 自己資金倍率（B/A）と最終想定運用益（B-A）を各年ごとに算出
      let equityRow = Array(holdingPeriod).fill(equity.toFixed(0));
      let equityMultiplierRow = resultsArray.map(r => (r.cumulativeATCFo / equity).toFixed(2));
      let finalOperatingProfitRow = resultsArray.map(r => (r.cumulativeATCFo - equity).toFixed(0));
      
      // 転置テーブルHTML作成
      let tableHTML = "<h2>年次シミュレーション結果</h2>";
      tableHTML += "<table>";
      // ヘッダー行（項目名＋各年）
      tableHTML += "<tr><th>項目</th>";
      for (let year = 1; year <= holdingPeriod; year++) {
        tableHTML += `<th>${year}年目</th>`;
      }
      tableHTML += "</tr>";
      
      // 各項目の行作成
      metricLabels.forEach(label => {
        tableHTML += `<tr><td>${label}</td>`;
        tableData[label].forEach(val => {
          tableHTML += `<td>${val}</td>`;
        });
        tableHTML += "</tr>";
      });
      
      // 追加の計算項目
      tableHTML += `<tr><td>運営売却キャッシュフロー累計（B）</td>`;
      tableData["累計ATCFo（税引後CF累計）"].forEach(val => {
        tableHTML += `<td>${val}</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += `<tr><td>自己資金（A）</td>`;
      equityRow.forEach(val => {
        tableHTML += `<td>${val}</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += `<tr><td>自己資金倍率（B/A）</td>`;
      equityMultiplierRow.forEach(val => {
        tableHTML += `<td>${val} 倍</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += `<tr><td>最終想定運用益（B-A）</td>`;
      finalOperatingProfitRow.forEach(val => {
        tableHTML += `<td>${val} 円</td>`;
      });
      tableHTML += "</tr>";
      
      tableHTML += "</table>";
      
      // 主要指標の表示（IRR等）
      let summaryHTML = "<h3>主要指標</h3>";
      summaryHTML += `<p>FCR（キャッシュフロー率）：${(FCR * 100).toFixed(2)} %</p>`;
      summaryHTML += `<p>ローン定数K：${(loanConstantK * 100).toFixed(2)} %</p>`;
      summaryHTML += `<p>イールドギャップ：${(yieldGap * 100).toFixed(2)} %</p>`;
      summaryHTML += `<p>IRR（税引前）：${(irrBefore * 100).toFixed(2)} %</p>`;
      summaryHTML += `<p>IRR（税引後）：${(irrAfter * 100).toFixed(2)} %</p>`;
      
      // 用語解説
      let glossaryHTML = "<h3>各指標の意味（用語解説）</h3><ul>";
      glossaryHTML += "<li>GPI（総潜在収入）：満室時の年間収入（＝月収×12）</li>";
      glossaryHTML += "<li>EGI（実効総収入）：GPIから空室損失・未回収損失を差し引き、雑収入を加えた実際の収入（概ねGPIの90% + 雑収入）</li>";
      glossaryHTML += "<li>OPEx（運営費用）：管理費、固都税、建物管理費などの合計</li>";
      glossaryHTML += "<li>NOI（純営業収益）：EGIからOPExを差し引いた収益</li>";
      glossaryHTML += "<li>ADS（元利返済額）：ローン返済額（元本＋利息）</li>";
      glossaryHTML += "<li>BTCFo（税引前CF）：NOIからADSを差し引いたキャッシュフロー</li>";
      glossaryHTML += "<li>ATCFo（税引後CF）：NOIからADSと税金（21%）を差し引いたキャッシュフロー</li>";
      glossaryHTML += "<li>累計ATCFo：各年のATCFoを累積した値</li>";
      glossaryHTML += "<li>残ローン残高：各年末時点のローン残高合計</li>";
      glossaryHTML += "<li>運営売却キャッシュフロー累計（B）：累計ATCFoのこと</li>";
      glossaryHTML += "<li>自己資金（A）：初期の自己資金</li>";
      glossaryHTML += "<li>自己資金倍率（B/A）：累計ATCFoを自己資金で割った値</li>";
      glossaryHTML += "<li>最終想定運用益（B-A）：累計ATCFoから自己資金を差し引いた値</li>";
      glossaryHTML += "</ul>";
      
      document.getElementById("results").innerHTML = tableHTML + summaryHTML + glossaryHTML;
    }
  </script>
</body>
</html>
